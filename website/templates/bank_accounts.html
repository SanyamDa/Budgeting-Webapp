{% extends "base.html" %}

{% block title %}Bank Accounts{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: white !important;" class="mb-0">Bank Accounts</h2>
                <button class="btn btn-primary" data-toggle="modal" data-target="#addBankModal">
                    <i class="bx bx-plus mr-2"></i>Link Bank Account
                </button>
            </div>

            <!-- Instructions Card -->
            <div class="card glass-card mb-4" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div class="card-body">
                    <h5 class="card-title mb-3" style="color: white !important;">
                        <i class="bx bx-info-circle me-2"></i>Important Instructions
                    </h5>
                    <div style="color: rgba(255, 255, 255, 0.9) !important;">
                        <p class="mb-2" style="color: white !important;"><strong>Before linking your bank account:</strong></p>
                        <ul class="mb-3" style="color: rgba(255, 255, 255, 0.9) !important;">
                            <li>Always add <strong>notes</strong> when making payments from your bank app</li>
                            <li>Format: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">"Payee Name - Purpose"</code></li>
                            <li>Examples: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">"Bike taxi - Transportation"</code>, <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">"Som tam vendor - Food"</code></li>
                            <li>This helps our AI categorize your expenses automatically</li>
                        </ul>
                        <div class="alert alert-info" style="background: rgba(13, 202, 240, 0.2); border: 1px solid rgba(13, 202, 240, 0.3); color: white !important;">
                            <i class="bx bx-bulb me-2"></i>
                            <strong>Pro Tip:</strong> The better your notes, the more accurate the automatic categorization!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bank Accounts List -->
            <div class="row">
                {% if bank_accounts %}
                    {% for account in bank_accounts %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card glass-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1" style="color: white !important;">{{ account.nickname or account.bank_name }}</h5>
                                        <p class="mb-0" style="color: rgba(255, 255, 255, 0.75) !important;">{{ account.bank_name }}</p>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-link p-0" style="color: white !important;" data-bs-toggle="dropdown">
                                            <i class="bx bx-dots-vertical-rounded"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="syncAccount('{{ account.id }}')">
                                                <i class="bx bx-sync me-2"></i>Sync Now
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="editAccount('{{ account.id }}')">
                                                <i class="bx bx-edit me-2"></i>Edit
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="removeAccount('{{ account.id }}')">
                                                <i class="bx bx-trash me-2"></i>Remove
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-white-50">Account Number</small>
                                    <p class="text-white mb-0">****{{ account.account_number[-4:] }}</p>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-white-50">Account Holder</small>
                                    <p class="text-white mb-0">{{ account.account_name }}</p>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge {{ 'bg-success' if account.is_active else 'bg-secondary' }}">
                                            {{ 'Active' if account.is_active else 'Inactive' }}
                                        </span>
                                    </div>
                                    <div>
                                        {% if account.last_sync %}
                                            <small class="text-white-50">
                                                Last sync: {{ account.last_sync.strftime('%d/%m/%Y %H:%M') }}
                                            </small>
                                        {% else %}
                                            <small class="text-warning">Never synced</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bx bx-bank fa-4x mb-3" style="color: rgba(255, 255, 255, 0.5) !important;"></i>
                            <h4 class="mb-3" style="color: white !important;">No Bank Accounts Linked</h4>
                            <p class="mb-4" style="color: rgba(255, 255, 255, 0.75) !important;">Link your first Thai bank account to start automatic expense tracking</p>
                            <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#addBankModal">
                                <i class="bx bx-plus mr-2"></i>Link Your First Bank Account
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Bank Account Modal -->
<div class="modal fade" id="addBankModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" style="color: white !important;">Link Bank Account</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addBankForm">
                    <div class="mb-3">
                        <label class="form-label text-white">Select Bank</label>
                        <select class="form-select bg-dark text-white border-secondary" name="bank_name" required onchange="toggleBankOptions()">
                            <option value="">Choose your bank...</option>
                            <option value="Kasikorn Bank">Kasikorn Bank (KBANK) - API Integration</option>
                        </select>
                    </div>
                    
                    <!-- Kasikorn Bank OAuth Option -->
                    <div id="kbankOAuth" style="display: none;">
                        <div class="alert alert-info" style="background: rgba(13, 202, 240, 0.2); border: 1px solid rgba(13, 202, 240, 0.3); color: white !important;">
                            <i class="bx bx-info-circle mr-2"></i>
                            <strong>Secure API Integration:</strong> Click below to securely connect your Kasikorn Bank account using Finverse API. You'll be redirected to Kasikorn Bank's secure login.
                        </div>
                        <div class="text-center">
                            <a href="{{ url_for('views.kbank_auth') }}" class="btn btn-success btn-lg">
                                <i class="bx bx-shield-check mr-2"></i>Connect with Kasikorn Bank API
                            </a>
                        </div>
                    </div>
                    
                    <!-- Manual Entry (Hidden since only K Bank is supported) -->
                    <div id="manualBankEntry" style="display: none;">
                        <div class="alert alert-info" style="background: rgba(13, 202, 240, 0.2); border: 1px solid rgba(13, 202, 240, 0.3); color: white !important;">
                            <i class="bx bx-info-circle mr-2"></i>
                            <strong>Only Kasikorn Bank Supported:</strong> Currently, we only support Kasikorn Bank integration via Finverse API.
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bx bx-shield-alt-2 mr-2"></i>
                        <strong>Security Note:</strong> We use bank-grade encryption to protect your account information. 
                        We only access transaction data, never your account balance or personal details.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" id="linkAccountBtn" class="btn btn-primary" onclick="linkBankAccount()" style="display: none;">
                    <i class="bx bx-link mr-2"></i>Link Account Manually
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleBankOptions() {
    const bankSelect = document.querySelector('select[name="bank_name"]');
    const kbankOAuth = document.getElementById('kbankOAuth');
    const manualEntry = document.getElementById('manualBankEntry');
    const linkBtn = document.getElementById('linkAccountBtn');
    
    if (bankSelect.value === 'Kasikorn Bank') {
        // Show Kasikorn Bank OAuth option
        kbankOAuth.style.display = 'block';
        manualEntry.style.display = 'none';
        linkBtn.style.display = 'none';
    } else {
        // Hide options when no bank selected
        kbankOAuth.style.display = 'none';
        manualEntry.style.display = 'none';
        linkBtn.style.display = 'none';
    }
}

function linkBankAccount() {
    const form = document.getElementById('addBankForm');
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Linking...';
    submitBtn.disabled = true;
    
    fetch('/api/bank_accounts/link', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('addBankModal')).hide();
            location.reload();
        } else {
            alert('Error linking bank account: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error linking bank account. Please try again.');
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function syncAccount(accountId) {
    if (confirm('Sync transactions from this bank account?')) {
        fetch(`/api/bank_accounts/${accountId}/sync`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully synced ${data.transactions_imported} transactions!`);
                location.reload();
            } else {
                alert('Error syncing account: ' + data.message);
            }
        });
    }
}

function removeAccount(accountId) {
    if (confirm('Are you sure you want to remove this bank account? This will not delete existing transactions.')) {
        fetch(`/api/bank_accounts/${accountId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error removing account: ' + data.message);
            }
        });
    }
}
</script>

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
}

.text-white-75 {
    color: rgba(255, 255, 255, 0.75) !important;
}

.text-white-50 {
    color: rgba(255, 255, 255, 0.5) !important;
}

code {
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    color: #ffc107;
}
</style>
{% endblock %}
