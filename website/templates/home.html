{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Top Section: Month Selector and Total Money Assigned -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="d-flex align-items-center">
                <button class="btn btn-link text-light mr-2" id="prevMonth">
                    <i class="bx bx-chevron-left"></i>
                </button>
                <h4 class="mb-0 text-white">{{ current_month }} {{ current_year }}</h4>
                <button class="btn btn-link text-light ml-2" id="nextMonth">
                    <i class="bx bx-chevron-right"></i>
                </button>
            </div>
            <small class="text-light">Enter a note...</small>
        </div>
        <div class="col-md-6 text-right">
            <div class="card d-inline-block px-4 py-2" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px;">
                <h1 class="text-white" style="font-size: 2rem; font-weight: 600;">${{ "{:.2f}".format(plan.monthly_income) }}</h1>
                <small class="text-light">All Money Assigned</small>
                <i class="bx bx-check-circle text-success ml-2"></i>
            </div>
        </div>
    </div>

    <!-- Filter Buttons -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group btn-group-toggle" data-toggle="buttons" role="group">
                <button type="button" class="btn btn-sm rounded-pill mr-2 filter-btn active" data-filter="all" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    padding: 0.4rem 1.2rem;
                    font-size: 0.8rem;
                    font-weight: 500;
                    letter-spacing: 0.5px;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                ">
                    All
                </button>
                <button type="button" class="btn btn-sm rounded-pill mr-2 filter-btn" data-filter="underfunded" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    padding: 0.4rem 1.2rem;
                    font-size: 0.8rem;
                    font-weight: 500;
                    letter-spacing: 0.5px;
                    opacity: 0.7;
                    transition: all 0.3s ease;
                ">
                    Underfunded
                </button>
                <button type="button" class="btn btn-sm rounded-pill filter-btn" data-filter="overfunded" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    padding: 0.4rem 1.2rem;
                    font-size: 0.8rem;
                    font-weight: 500;
                    letter-spacing: 0.5px;
                    opacity: 0.7;
                    transition: all 0.3s ease;
                ">
                    Overfunded
                </button>
                <i class="bx bx-info-circle text-white ml-3 align-self-center" data-toggle="tooltip" data-placement="top" title="Filter categories by funding status"></i>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Budget Categories Section -->
        <div class="col-lg-8">
            <!-- Category Group Options -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-primary active group-btn" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        border-radius: 8px;
                        padding: 0.5rem 1.2rem;
                        font-size: 0.85rem;
                        font-weight: 500;
                        letter-spacing: 0.3px;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
                    ">
                        <i class="bx bx-category mr-1"></i> Category Group
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-light rounded mr-2" id="toggleProgressBars" 
                        style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"
                        data-toggle="tooltip" data-placement="top" title="Toggle progress bars">
                        <i class="bx bx-bar-chart-alt-2"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light rounded" 
                        style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;"
                        data-toggle="tooltip" data-placement="top" title="Change view">
                        <i class="bx bx-list-ul"></i>
                    </button>
                </div>
            </div>

            <!-- Budget Categories Table -->
            <div class="card shadow-sm" style="background: rgba(20, 20, 35, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" style="color: #e0e0e0; margin-bottom: 0; border-collapse: separate; border-spacing: 0;">
                            <thead style="background-color: rgba(0, 0, 0, 0.4);">
                                <tr>
                                    <th class="border-0 text-white py-3 px-4" style="font-weight: 500; font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.08) !important;">CATEGORY</th>
                                    <th class="border-0 text-right text-white py-3 px-4" style="font-weight: 500; font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.08) !important;">ASSIGNED</th>
                                    <th class="border-0 text-right text-white py-3 px-4" style="font-weight: 500; font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.08) !important;">ACTIVITY</th>
                                    <th class="border-0 text-right text-white py-3 px-4" style="font-weight: 500; font-size: 0.8rem; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.08) !important;">AVAILABLE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Needs Category -->
                                <tr class="category-header" data-category="needs" style="cursor: pointer;">
                                    <td class="py-3 px-4">
                                        <div class="d-flex align-items-center">
                                            <i class="bx bx-chevron-down category-toggle mr-3" style="font-size: 1rem;"></i>
                                            <div>
                                                <h6 class="mb-0 text-white" style="font-size: 0.9rem;">Needs</h6>
                                                
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right py-3 px-4"><span style="font-size: 0.9rem; font-weight: 500;">${{ "%.2f"|format(category_totals.needs.assigned) }}</span></td>
                                    <td class="text-right py-3 px-4"><span style="font-size: 0.9rem; font-weight: 500;">${{ "%.2f"|format(category_totals.needs.spent) }}</span></td>
                                    <td class="text-right py-3 px-4"><span class="badge px-3 py-2" style="background: rgba(255, 255, 255, 0.1); font-size: 0.8rem;">${{ "%.2f"|format(category_totals.needs.available) }}</span></td>
                                </tr>
                                <!-- Needs Subcategories -->
                                {% for category in categories.needs %}
                                <tr class="subcategory-row needs-subcategory" style="background-color: rgba(255, 255, 255, 0.03);">
                                    <td class="py-2 px-4" style="padding-left: 2.5rem !important;">
                                        <span style="font-size: 0.85rem;">{{ category.name }}</span>
                                    </td>
                                    <td class="text-right py-2 px-4"><span class="editable-amount" data-category-id="{{ category.id }}" style="font-size: 0.85rem; cursor: pointer;">${{ "%.2f"|format(category.assigned_amount) }}</span></td>
                                    <td class="text-right py-2 px-4"><span style="font-size: 0.85rem;">${{ "%.2f"|format(category.spent_amount) }}</span></td>
                                    <td class="text-right py-2 px-4"><span class="{% if category.available_amount < 0 %}text-danger{% else %}text-white-50{% endif %}" style="font-size: 0.85rem;">${{ "%.2f"|format(category.available_amount) }}</span></td>
                                </tr>
                                {% endfor %}

                                <!-- Wants Category -->
                                <tr class="category-header" data-category="wants" style="cursor: pointer;">
                                    <td class="py-3 px-4">
                                        <div class="d-flex align-items-center">
                                            <i class="bx bx-chevron-down category-toggle mr-3" style="font-size: 1rem;"></i>
                                            <div>
                                                <h6 class="mb-0 text-white" style="font-size: 0.9rem;">Wants</h6>
                                                
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right py-3 px-4"><span style="font-size: 0.9rem; font-weight: 500;">${{ "%.2f"|format(category_totals.wants.assigned) }}</span></td>
                                    <td class="text-right py-3 px-4"><span style="font-size: 0.9rem; font-weight: 500;">${{ "%.2f"|format(category_totals.wants.spent) }}</span></td>
                                    <td class="text-right py-3 px-4"><span class="badge px-3 py-2" style="background: rgba(255, 255, 255, 0.1); font-size: 0.8rem;">${{ "%.2f"|format(category_totals.wants.available) }}</span></td>
                                </tr>
                                <!-- Wants Subcategories -->
                                {% for category in categories.wants %}
                                <tr class="subcategory-row wants-subcategory" style="background-color: rgba(255, 255, 255, 0.03);">
                                    <td class="py-2 px-4" style="padding-left: 2.5rem !important;">
                                        <span style="font-size: 0.85rem;">{{ category.name }}</span>
                                    </td>
                                    <td class="text-right py-2 px-4"><span class="editable-amount" data-category-id="{{ category.id }}" style="font-size: 0.85rem; cursor: pointer;">${{ "%.2f"|format(category.assigned_amount) }}</span></td>
                                    <td class="text-right py-2 px-4"><span style="font-size: 0.85rem;">${{ "%.2f"|format(category.spent_amount) }}</span></td>
                                    <td class="text-right py-2 px-4"><span class="{% if category.available_amount < 0 %}text-danger{% else %}text-white-50{% endif %}" style="font-size: 0.85rem;">${{ "%.2f"|format(category.available_amount) }}</span></td>
                                </tr>
                                {% endfor %}

                                <!-- Investments Category -->
                                <tr class="category-header" data-category="investments" style="cursor: pointer;">
                                    <td class="py-3 px-4">
                                        <div class="d-flex align-items-center">
                                            <i class="bx bx-chevron-down category-toggle mr-3" style="font-size: 1rem;"></i>
                                            <div>
                                                <h6 class="mb-0 text-white" style="font-size: 0.9rem;">Investments</h6>
                                                
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right py-3 px-4"><span style="font-size: 0.9rem; font-weight: 500;">${{ "%.2f"|format(category_totals.investments.assigned) }}</span></td>
                                    <td class="text-right py-3 px-4"><span style="font-size: 0.9rem; font-weight: 500;">${{ "%.2f"|format(category_totals.investments.spent) }}</span></td>
                                    <td class="text-right py-3 px-4"><span class="badge px-3 py-2" style="background: rgba(255, 255, 255, 0.1); font-size: 0.8rem;">${{ "%.2f"|format(category_totals.investments.available) }}</span></td>
                                </tr>
                                <!-- Investments Subcategories -->
                                {% for category in categories.investments %}
                                <tr class="subcategory-row investments-subcategory" style="background-color: rgba(255, 255, 255, 0.03);">
                                    <td class="py-2 px-4" style="padding-left: 2.5rem !important;">
                                        <span style="font-size: 0.85rem;">{{ category.name }}</span>
                                    </td>
                                    <td class="text-right py-2 px-4"><span class="editable-amount" data-category-id="{{ category.id }}" style="font-size: 0.85rem; cursor: pointer;">${{ "%.2f"|format(category.assigned_amount) }}</span></td>
                                    <td class="text-right py-2 px-4"><span style="font-size: 0.85rem;">${{ "%.2f"|format(category.spent_amount) }}</span></td>
                                    <td class="text-right py-2 px-4"><span class="{% if category.available_amount < 0 %}text-danger{% else %}text-white-50{% endif %}" style="font-size: 0.85rem;">${{ "%.2f"|format(category.available_amount) }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Month Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px 16px 0 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h6 class="mb-0 text-white">
                        <i class="bx bx-calendar mr-2"></i>
                        {{ current_month }}'s Summary
                        <i class="bx bx-chevron-down ml-auto"></i>
                    </h6>
                </div>
                <div class="card-body" style="color: #e0e0e0;">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-light">Left Over from Last Month</span>
                            <span class="text-white">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-light">Assigned in {{ current_month }}</span>
                            <span class="text-white">${{ "%.2f"|format(total_assigned) }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-light">Activity</span>
                            <span class="text-danger">-${{ "%.2f"|format(total_spent) }}</span>
                        </div>
                        <hr style="border-color: rgba(255, 255, 255, 0.3);">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-light">Available</span>
                            <span class="text-success font-weight-bold">${{ "%.2f"|format(available_amount) }}</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6 class="text-light mb-3">Cost to Be Me</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-light">{{ current_month }}'s Targets</span>
                            <span class="text-white">$200.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-light">Expected Income</span>
                            <span class="text-white">${{ "%.2f"|format(plan.monthly_income or 0) }} <i class="bx bx-edit text-light"></i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Amount Modal -->
<div class="modal fade" id="editAmountModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Assigned Amount</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editAmountForm">
                    <div class="form-group">
                        <label for="categoryName">Category</label>
                        <input type="text" class="form-control" id="categoryName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="assignedAmount">Assigned Amount</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">$</span>
                            </div>
                            <input type="number" class="form-control" id="assignedAmount" step="0.01" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAmountBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
// Category toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Dropdown toggle for budget categories
    const categoryHeaders = document.querySelectorAll('.category-header');
    categoryHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const category = this.dataset.category;
            const subcategoryRows = document.querySelectorAll(`.subcategory-row.${category}-subcategory`);
            const icon = this.querySelector('.category-toggle');

            let anyHidden = false;
            subcategoryRows.forEach(row => {
                row.classList.toggle('d-none');
                if (row.classList.contains('d-none')) anyHidden = true;
            });

            // Update icon based on new state (hidden -> right, shown -> down)
            if (icon) {
                if (anyHidden) {
                    icon.classList.remove('bx-chevron-down');
                    icon.classList.add('bx-chevron-right');
                } else {
                    icon.classList.remove('bx-chevron-right');
                    icon.classList.add('bx-chevron-down');
                }
            }
        });
    });
    
    // Editable amount functionality
    let currentCategoryId = null;
    let currentAmountElement = null;

    /* ---------- OPEN ALL CATEGORIES ON INITIAL LOAD ---------- */
    // Show every sub-category row
    document.querySelectorAll('.subcategory-row').forEach(row => {
        row.classList.remove('d-none');      // remove possible hidden class
        row.style.display = 'table-row';     // guarantee visibility
    });
    // Make sure each chevron points down
    document.querySelectorAll('.category-toggle').forEach(icon => {
        icon.classList.remove('bx-chevron-right', 'rotate-90');
        icon.classList.add('bx-chevron-down');
    });
    /* --------------------------------------------------------- */
    
    // Editable amount functionality
    
    document.querySelectorAll('.editable-amount').forEach(element => {
        element.addEventListener('click', function() {
            currentCategoryId = this.dataset.categoryId;
            currentAmountElement = this;
            
            // Get category name from the row
            const categoryName = this.closest('tr').querySelector('span').textContent;
            const currentAmount = parseFloat(this.textContent.replace('$', ''));
            
            // Populate modal
            document.getElementById('categoryName').value = categoryName;
            document.getElementById('assignedAmount').value = currentAmount;
            
            // Show modal
            $('#editAmountModal').modal('show');
        });
    });
    
    // Save amount functionality
    document.getElementById('saveAmountBtn').addEventListener('click', function() {
        const newAmount = parseFloat(document.getElementById('assignedAmount').value);
        
        if (isNaN(newAmount) || newAmount < 0) {
            alert('Please enter a valid amount');
            return;
        }
        
        // Show loading state
        const saveBtn = this;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;
        
        // Make API call
        fetch('/api/update-assigned', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                category_id: currentCategoryId,
                amount: newAmount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the display
                currentAmountElement.textContent = '$' + newAmount.toFixed(2);
                
                // Show success message
                showToast('Amount updated successfully!', 'success');
                
                // Close modal
                $('#editAmountModal').modal('hide');
                
                // Refresh the page to update totals
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Error updating amount: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error updating amount', 'error');
        })
        .finally(() => {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        });
    });
    
    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '0.7';
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            this.style.opacity = '1';
            
            const filter = this.dataset.filter;
            
            // Filter logic here (implement based on your needs)
            // For now, just show all categories
            document.querySelectorAll('.category-header').forEach(header => {
                header.style.display = 'table-row';
            });
        });
    });
});

// Toast notification function
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '1055';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bx ${type === 'success' ? 'bx-check-circle' : 'bx-x-circle'} mr-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>

<style>
/* Ripple effect for buttons */
.btn {
    position: relative;
    overflow: hidden;
}

.ripple {
    position: absolute;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.7);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* Modal animations */
.modal.fade .modal-dialog {
    transform: translateY(-50px);
    transition: transform 0.3s ease-out, opacity 0.3s ease;
    opacity: 0;
}

.modal.show .modal-dialog {
    transform: translateY(0);
    opacity: 1;
}

/* Input focus effects */
.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

/* Toast notifications */
.toast {
    min-width: 250px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border: none;
}

.toast-body {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
}

/* Loading spinner */
.spinner-border {
    width: 1rem;
    height: 1rem;
    border-width: 0.15em;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .btn-group {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
    }
}

/* Custom styles for the budget table */
.category-header:hover {
    background-color: rgba(255, 255, 255, 0.03) !important;
}

/* Smooth transitions for interactive elements */
.btn, .filter-btn, .group-btn, .editable-amount {
    transition: all 0.25s ease !important;
}

/* Hover effects for filter buttons */
.filter-btn:not(.active):hover {
    opacity: 0.9 !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
}

/* Active state for filter buttons */
.filter-btn.active {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25) !important;
    transform: translateY(-1px);
}

/* Loading spinner */
.loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-left: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Tooltip styling */
.tooltip {
    font-size: 0.8rem;
    padding: 0.5rem 0.8rem;
}

/* Table row hover effect */
tbody tr:not(.category-header):hover {
    background-color: rgba(255, 255, 255, 0.03) !important;
}

/* Category header chevron rotation */
.bx-chevron-down {
    transition: transform 0.3s ease;
}

.rotate-90 {
    transform: rotate(-90deg);
}
</style>

<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    let currentCategoryId = null;
    let isLoading = false;
    
    // Add loading spinner to save button
    const saveBtn = document.getElementById('saveAmountBtn');
    const saveBtnOriginalText = saveBtn.innerHTML;
    
    // Show loading state
    const showLoading = (element, show = true) => {
        if (show) {
            element.disabled = true;
            element.innerHTML = `
                <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                Saving...
            `;
        } else {
            element.disabled = false;
            element.innerHTML = saveBtnOriginalText;
        }
    };
    
    // Show toast notification
    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '1100';
        toast.role = 'alert';
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bx ${type === 'success' ? 'bx-check-circle' : 'bx-error'} mr-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    };

    // Category collapse/expand functionality with smooth animation
    document.querySelectorAll('.category-header').forEach(function(header) {
        header.addEventListener('click', function(e) {
            // Don't trigger if clicking on a button or input
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('button, input, a, .btn')) {
                return;
            }
            
            const category = this.dataset.category;
            const chevron = this.querySelector('.bx-chevron-down, .bx-chevron-right');
            const subcategories = document.querySelectorAll(`.subcategory-row.${category}-subcategory`);

            
            // Toggle chevron with rotation animation
            chevron.classList.toggle('rotate-90');
            
            // Toggle subcategory visibility with animation
            subcategories.forEach(function(row) {
                if (row.style.display === 'none' || !row.style.display) {
                    // Show with slide down
                    row.style.display = 'table-row';
                    const height = row.offsetHeight;
                    row.style.height = '0';
                    row.style.opacity = '0';
                    row.style.transition = 'all 0.3s ease-in-out';
                    
                    // Trigger reflow
                    void row.offsetHeight;
                    
                    row.style.height = height + 'px';
                    row.style.opacity = '1';
                    
                    // Reset height after animation
                    setTimeout(() => {
                        row.style.height = '';
                    }, 300);
                } else {
                    // Hide with slide up
                    const height = row.offsetHeight;
                    row.style.height = height + 'px';
                    row.style.opacity = '1';
                    
                    // Trigger reflow
                    void row.offsetHeight;
                    
                    row.style.height = '0';
                    row.style.opacity = '0';
                    row.style.overflow = 'hidden';
                    
                    // Hide after animation
                    setTimeout(() => {
                        row.style.display = 'none';
                        row.style.height = '';
                        row.style.opacity = '';
                    }, 300);
                }
            });
            
            // Add slight background color change on click for feedback
            this.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
            setTimeout(() => {
                this.style.backgroundColor = '';
            }, 200);
        });
    });

    // Filter buttons functionality with ripple effect
    document.querySelectorAll('[data-filter]').forEach(function(btn) {
        // Add ripple effect
        btn.addEventListener('click', function(e) {
            // Remove active class from all buttons and reset styling
            document.querySelectorAll('[data-filter]').forEach(b => {
                b.classList.remove('active');
                b.style.opacity = '0.7';
                b.style.transform = 'translateY(0)';
                b.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
            });
            
            // Add active class to clicked button with animation
            this.classList.add('active');
            this.style.opacity = '1';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.25)';
            
            // Add ripple effect
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            
            this.appendChild(ripple);
            
            // Remove ripple after animation
            setTimeout(() => {
                ripple.remove();
            }, 600);
            
            // Apply filter (placeholder for actual filtering logic)
            const filter = this.dataset.filter;
            console.log('Filter:', filter);
            
            // Show loading state
            const tableBody = document.querySelector('table tbody');
            tableBody.style.opacity = '0.7';
            tableBody.style.transition = 'opacity 0.3s';
            
            // Simulate API call
            setTimeout(() => {
                // In a real app, this would be an API call to filter data
                tableBody.style.opacity = '1';
                
                // Show feedback based on filter
                let message = '';
                switch(filter) {
                    case 'all':
                        message = 'Showing all categories';
                        break;
                    case 'underfunded':
                        message = 'Showing underfunded categories';
                        break;
                    case 'overfunded':
                        message = 'Showing overfunded categories';
                        break;
                }
                showToast(message, 'info');
            }, 500);
        });
    });

    // Progress bars toggle
    let progressBarsVisible = true;
    document.getElementById('toggleProgressBars').addEventListener('click', function() {
        progressBarsVisible = !progressBarsVisible;
        const progressBars = document.querySelectorAll('.progress-bar-container');
        progressBars.forEach(bar => {
            bar.style.display = progressBarsVisible ? 'block' : 'none';
        });
        
        this.classList.toggle('btn-outline-secondary');
        this.classList.toggle('btn-secondary');
    });

    // Editable amount functionality
    document.querySelectorAll('.editable-amount').forEach(function(element) {
        element.addEventListener('click', function() {
            currentCategoryId = this.dataset.categoryId;
            const currentAmount = parseFloat(this.dataset.currentAmount);
            const categoryName = this.closest('tr').querySelector('td span').textContent;
            
            document.getElementById('categoryName').value = categoryName;
            document.getElementById('assignedAmount').value = currentAmount;
            
            $('#editAmountModal').modal('show');
        });
        
        // Add cursor pointer to show it's clickable
        element.style.cursor = 'pointer';
        element.classList.add('text-primary');
    });

    // Save amount functionality with loading state and better feedback
    document.getElementById('saveAmountBtn').addEventListener('click', function() {
        if (isLoading) return;
        
        const newAmount = parseFloat(document.getElementById('assignedAmount').value);
        const amountInput = document.getElementById('assignedAmount');
        
        // Input validation
        if (isNaN(newAmount) || newAmount < 0) {
            amountInput.classList.add('is-invalid');
            showToast('Please enter a valid positive amount', 'danger');
            return;
        }
        
        // Remove any previous error states
        amountInput.classList.remove('is-invalid');
        
        // Show loading state
        isLoading = true;
        showLoading(this, true);
        
        // Send update to backend
        fetch('/api/update-assigned', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                category_id: currentCategoryId,
                amount: newAmount
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update the displayed amount with animation
                const amountElement = document.querySelector(`[data-category-id="${currentCategoryId}"]`);
                const oldAmount = parseFloat(amountElement.dataset.currentAmount || 0);
                
                // Animate the number change
                if (amountElement) {
                    amountElement.style.transition = 'all 0.3s ease';
                    amountElement.style.color = newAmount > oldAmount ? '#4caf50' : '#f44336';
                    amountElement.style.transform = 'scale(1.1)';
                    
                    setTimeout(() => {
                        amountElement.textContent = `$${newAmount.toFixed(2)}`;
                        amountElement.dataset.currentAmount = newAmount;
                        
                        setTimeout(() => {
                            amountElement.style.color = '';
                            amountElement.style.transform = '';
                        }, 300);
                    }, 150);
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAmountModal'));
                modal.hide();
                
                // Show success message
                showToast('Budget updated successfully!', 'success');
                
                // Update the total assigned amount with animation
                const totalAssignedElement = document.querySelector('.total-assigned');
                if (totalAssignedElement) {
                    const currentTotal = parseFloat(totalAssignedElement.textContent.replace(/[^0-9.-]+/g,""));
                    const difference = newAmount - oldAmount;
                    const newTotal = currentTotal + difference;
                    
                    totalAssignedElement.style.transition = 'all 0.3s ease';
                    totalAssignedElement.style.color = difference > 0 ? '#4caf50' : '#f44336';
                    totalAssignedElement.style.transform = 'scale(1.05)';
                    
                    setTimeout(() => {
                        totalAssignedElement.textContent = `$${newTotal.toFixed(2)}`;
                        
                        setTimeout(() => {
                            totalAssignedElement.style.color = '';
                            totalAssignedElement.style.transform = '';
                        }, 300);
                    }, 150);
                }
            } else {
                throw new Error(data.error || 'Failed to update amount');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast(error.message || 'Error updating amount. Please try again.', 'danger');
        })
        .finally(() => {
            isLoading = false;
            showLoading(document.getElementById('saveAmountBtn'), false);
        });
    });
    
    // Handle modal events
    const editModal = document.getElementById('editAmountModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const categoryId = button.getAttribute('data-category-id');
            const currentAmount = parseFloat(button.getAttribute('data-current-amount') || 0);
            const categoryName = button.closest('tr').querySelector('td:first-child').textContent.trim();
            
            currentCategoryId = categoryId;
            const modalTitle = editModal.querySelector('.modal-title');
            const amountInput = editModal.querySelector('#assignedAmount');
            
            modalTitle.textContent = `Edit ${categoryName} Budget`;
            amountInput.value = currentAmount.toFixed(2);
            amountInput.select();
            
            // Reset validation state
            amountInput.classList.remove('is-invalid');
        });
        
        editModal.addEventListener('shown.bs.modal', function () {
            document.getElementById('assignedAmount').focus();
        });
        
        editModal.addEventListener('hidden.bs.modal', function () {
            // Reset form and state
            const form = editModal.querySelector('form');
            if (form) form.reset();
            currentCategoryId = null;
        });
    }

    // Month navigation
    document.getElementById('prevMonth').addEventListener('click', function() {
        console.log('Previous month');
    });

    document.getElementById('nextMonth').addEventListener('click', function() {
        console.log('Next month');
    });
});
</script>
{% endblock %}
